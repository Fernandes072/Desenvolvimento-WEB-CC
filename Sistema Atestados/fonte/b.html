<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>Requerimento de Atestado</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
        <link rel="icon" href="icone2.png" type="image/x-icon">
        <link rel="stylesheet" href="estilo.css">
    </head>
    <body>
        <header id="main-header" class="mt-auto">
            <div class="col-xxl-6 col-xl-7 col-lg-8 col-md-9 col-12 rounded px-4 py-3">
                <div class="row">
                    <div class="col">
                       <img src="logo.png" alt="Logo" class="logo">
                    </div>
                    <div class="col mt-5">
                        <h1 class="titulo">Requerimento de Atestado</h1>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-block">
            <form id="form-atestado" class="col-xxl-6 col-xl-7 col-lg-8 col-md-9 col-12 rounded px-4 py-3 ca-block">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <div class="form-floating mb-2">
                                <input id="nome" name="nome" placeholder="Nome Completo" type="text" class="form-control" />
                                <label for="nome">Nome Completo<span class="asterisco-required"> *</span></label>
                                <div id="nome_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-floating mb-2">
                                <input id="matricula" name="matricula" placeholder="Matrícula" type="text" class="form-control" />
                                <label for="matricula">Matrícula<span class="asterisco-required"> *</span></label>
                                <div id="matricula_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating mb-2">
                                <input id="cpf" name="cpf" placeholder="CPF" type="text" class="form-control" />
                                <label for="cpf">CPF<span class="asterisco-required"> *</span></label>
                                <div id="cpf_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-floating mb-2">
                                <input id="email" name="email" placeholder="E-Mail" type="email" class="form-control" />
                                <label for="email">E-Mail<span class="asterisco-required"> *</span></label>
                                <div id="email_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-floating mb-2">
                                <input id="telefone" name="telefone" placeholder="Telefone" type="text" class="form-control" />
                                <label for="telefone">Telefone<span class="asterisco-required"> *</span></label>
                                <div id="telefone_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                          <div class="mb-2 form-floating">
                              <select id="modalidade" class="form-select form-select-lg mb-3" name="modalidade">
                                <option value="" selected disabled>Selecione</option>
                                <option value="inte">Integrado</option>
                                <option value="subs">Subsequente</option>
                                <option value="grad">Graduação</option>
                              </select>
                              <label for="modalidade">Modalidade<span class="asterisco-required"> *</span></label>
                            <div id="modalidade_err" class="invalid-feedback"></div>
                          </div>
                        </div>
                        <div class="col">
                          <div class="mb-2 form-floating">
                            <select class="form-select form-select-lg mb-3" id="curso" name="curso" aria-label="Floating label select example">
                              <option value="" selected disabled>Selecione</option>
                            </select>
                            <label for="curso">Curso</label>
                            <div id="curso_err" class="invalid-feedback"></div>
                          </div>
                        </div>
                          <div class="col">
                            <div class="mb-2 form-floating">
                              <select id="turma" class="form-select form-select-lg mb-3" name="turma">
                                <option value="" selected disabled>Selecione</option>
                              </select>
                              <label for="turma">Turma<span class="asterisco-required"> *</span></label>
                              <div id="turma_err" class="invalid-feedback"></div>
                            </div>
                          </div>  
                      </div>
                    <div class="form-floating mb-2">
                        <textarea id="msg" name="msg" placeholder="Mensagem" class="form-control" rows="7" style="height: 100px"></textarea>
                        <label for="msg">Informações</label>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label for="arquivo" class="form-label"></label>
                                <input class="form-control formArquivo" type="file" id="arquivo">
                                <div id="arquivo_err" class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                                <label class="form-check-label" for="flexCheckDefault">
                                    Deseja receber um email de confirmação?
                                </label>
                              </div>
                        </div>
                    </div>
                    <br>
                    <div class="d-md-block d-grid">
                        <input value="Enviar" type="submit" class="btn btn-primary" />
                    </div>
                </div>
            </form>
        </main>
        <script>
            validate = {
                /** Função para validar nomes. */
                nome: function(s)  {
                    let s_fmt = this.string_all_trim(s) // string formatada, tratada
                    if ( !s_fmt ) // check string vazia (ou null)
                        return false
                    if ( s_fmt.split(' ').length < 2 ) // check para nome e sobrenome
                        return false
                    return true
                },
                matricula: function(s) {
                    let s_fmt = this.string_all_trim(s)
                    if ( s_fmt.length < 10 )
                        return false
                    return true
                },
                cpf: function(s) {
                    let regex_cpf = /^(\d{3}\.?\d{3}\.?\d{3}-?\d{2})$/,
                        s_fmt = this.string_all_trim(s)
                    if ( !regex_cpf.test(s_fmt) )
                        return false
                    return true
                },
                email: function(s) {
                    let regex_email = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$/,
                        s_fmt = this.string_all_trim(s)
                    if ( !regex_email.test(s_fmt) )
                        return false
                    return true
                },
                telefone: function(s) {
                    regex_telf = /^\d{2}\d{4,5}\d{4}$/
                    let s_fmt = this.string_all_trim(s)
                    if ( !regex_telf.test(s_fmt) )
                        return false
                    return true
                },
                curso: function(s) {
                    let select = document.getElementById('curso');
                    if (select.value == '')
                        return false
                    return true
                },
                turma: function(s) {
                    let select = document.getElementById('turma');
                    if (select.value == '')
                        return false
                    return true
                },
                msg: function(s) {
                    let s_fmt = this.string_all_trim(s)
                    if ( !s_fmt || s_fmt.length < 80 )
                        return false
                    return true
                },
                arquivo: function(s) {
                    let arq = document.getElementById('arquivo');
                    if ( arq.value == ''){
                        return false
                    } else {
                        let tipoPermitido = ['application/pdf'];
                        let tamanhoMaximo = 5 * 1024 * 1024 ; // 5 MB
                        let arqui = arq.files[0];
                        let tamanhoArq = arqui.size;
                        let tipoArq = arqui.type;
                        if (tamanhoArq > tamanhoMaximo || !tipoPermitido.includes(tipoArq)){
                            return false
                        }
                    }
                    return true
                },
                string_all_trim: function(s) {
                    if ( !s ) // é o mesmo que ( (s === null) || (s === '') )
                        return s
                    // s.replace(/\s+/,' '), substitui espaçamentos duplos ou mais por simples ' '
                    // s = s.replace(/^\s+|\s+$/,''), remove os espaçamentos antes ou depois da string
                    return s.replace(/\s+/g,' ').replace(/^\s+|\s+$/g,'')
                }
            }

            for (const id of ['nome', 'matricula', 'cpf', 'email', 'telefone', 'curso', 'turma', 'msg', 'arquivo']) {
                document.getElementById(id).addEventListener('change', (ev) => {
                    ev.target.value = validate.string_all_trim( ev.target.value )
                })
            }

            let cursosPorModalidade = {
            'inte': [
                { id: 'iagro', nome: 'Agronegócio' },
                { id: 'imsi', nome: 'Manutenção e Suporte em Informática' }
            ],
            'subs': [
                { id: 'sagro', nome: 'Agronegócio' }
            ],
            'grad': [
                { id: 'ccomp', nome: 'Ciência da Computação' },
                { id: 'log', nome: 'Logística' }
            ],
            };
    let turmasPorModalidade = {
            'grad': [
                { id: '1per', nome: '1° Período' },
                { id: '2per', nome: '2° Período' },
                { id: '3per', nome: '3° Período' },
                { id: '4per', nome: '4° Período' },
                { id: '5per', nome: '5° Período' },
                { id: '6per', nome: '6° Período' },
                { id: '7per', nome: '7° Período' },
                { id: '8per', nome: '8° Período' }
            ],
            'subs': [
                { id: '1per', nome: '1° Período' },
                { id: '2per', nome: '2° Período' },
                { id: '3per', nome: '3° Período' },
                { id: '4per', nome: '4° Período' },
                { id: '5per', nome: '5° Período' },
                { id: '6per', nome: '6° Período' },
            ],
            'inte': [
                { id: '1ano', nome: '1° Ano' },
                { id: '2ano', nome: '2° Ano' },
                { id: '3ano', nome: '3° Ano' },
            ]
            };

            let cursoSelect = document.getElementById('curso');
            let turmaSelect = document.getElementById('turma');
            let modalidadeSelect = document.getElementById('modalidade');
            
            modalidadeSelect.addEventListener('change', function() {
            let modalidadeId = modalidadeSelect.value;
            if (modalidadeId) {
                // curso selecionado, buscar turmas correspondentes
                let cursos = cursosPorModalidade[modalidadeId];
                // limpar opções anteriores
                cursoSelect.innerHTML = '<option value="" selected disabled>Selecione</option>';
                // adicionar novas opções
                cursos.forEach(curso => {
                let option = document.createElement('option');
                option.value = curso.id;
                option.text = curso.nome;
                cursoSelect.add(option);
                });
            } else {
                // curso não selecionado, limpar opções de turma
                cursoSelect.innerHTML = '<option value="" selected disabled>Selecione</option>';
            }
            });

            modalidadeSelect.addEventListener('change', function() {
            let modalidadeId = modalidadeSelect.value;
            if (modalidadeId) {
                // curso selecionado, buscar turmas correspondentes
                let turmas = turmasPorModalidade[modalidadeId];
                // limpar opções anteriores
                turmaSelect.innerHTML = '<option value="" selected disabled>Selecione</option>';
                // adicionar novas opções
                turmas.forEach(turma => {
                let option = document.createElement('option');
                option.value = turma.id;
                option.text = turma.nome;
                turmaSelect.add(option);
                });
            } else {
                // curso não selecionado, limpar opções de turma
                turmaSelect.innerHTML = '<option value="" selected disabled>Selecione</option>';
            }
            });
            const main_form = document.getElementById('form-atestado')
            main_form.addEventListener( 'submit', (ev) => {
                const form_data = new FormData( main_form )
                console.log( JSON.stringify(Object.fromEntries(form_data)) )
                let msg_dict = {
                    'nome_err':'', 'matricula_err':'', 'cpf_err':'', 'email_err':'', 'telefone_err':'', 'curso_err':'', 'turma_err': '', 'arquivo_err':''}

                //Validação nome    
                if ( !validate.nome(form_data.get('nome')) ){
                    msg_dict['nome_err'] = 'Nome inválido!'
                    document.getElementById('nome').classList.add('is-invalid')
                } else {
                    document.getElementById('nome').classList.remove('is-invalid')
                }

                //Validação matricula
                if ( !validate.matricula(form_data.get('matricula')) ){
                    msg_dict['matricula_err'] = 'Matrícula inválida'
                    document.getElementById('matricula').classList.add('is-invalid')
                } else {
                    document.getElementById('matricula').classList.remove('is-invalid')
                }

                //Validação cpf
                if ( !validate.cpf(form_data.get('cpf')) ){
                    msg_dict['cpf_err'] = 'CPF inválido'
                    document.getElementById('cpf').classList.add('is-invalid')
                } else {
                    document.getElementById('cpf').classList.remove('is-invalid')
                }

                //Validação email
                if ( !validate.email(form_data.get('email')) ){
                    msg_dict['email_err'] = 'Email inválido!'
                    document.getElementById('email').classList.add('is-invalid')
                } else {
                    document.getElementById('email').classList.remove('is-invalid')
                }

                //Validação telefone
                if ( !validate.telefone(form_data.get('telefone')) ){
                    msg_dict['telefone_err'] = 'Telefone inválido!'
                    document.getElementById('telefone').classList.add('is-invalid')
                } else {
                    document.getElementById('telefone').classList.remove('is-invalid')
                }

                //Validação curso
                if ( !validate.curso(form_data.get('curso')) ){
                    msg_dict['curso_err'] = 'Selecione um curso!'
                    document.getElementById('curso').classList.add('is-invalid')
                } else {
                    document.getElementById('curso').classList.remove('is-invalid')
                }

                //Validação turma
                if ( !validate.turma(form_data.get('turma')) ){
                    msg_dict['turma_err'] = 'Selecione uma turma!'
                    document.getElementById('turma').classList.add('is-invalid')
                } else {
                    document.getElementById('turma').classList.remove('is-invalid')
                }

                //Validação arquivo
                if ( !validate.arquivo(form_data.get('arquivo')) ){
                    let arq = document.getElementById('arquivo');
                    if ( arq.value == ''){
                        msg_dict['arquivo_err'] = 'Selecione um arquivo!'
                    } else {
                        let tipoPermitido = ['application/pdf'];
                        let tamanhoMaximo = 5 * 1024 * 1024 ; // 5 MB
                        let arqui = arq.files[0];
                        let tamanhoArq = arqui.size;
                        let tipoArq = arqui.type;
                        if (tamanhoArq > tamanhoMaximo || !tipoPermitido.includes(tipoArq)){
                            msg_dict['arquivo_err'] = 'Arquivo inválido!'
                        }
                    }
                    document.getElementById('arquivo').classList.add('is-invalid')
                } else {
                    document.getElementById('arquivo').classList.remove('is-invalid')
                }
                //
                let ok = true
                for (const [key, value] of Object.entries(msg_dict)) {
                    document.getElementById(key).innerText = value
                    if ( value.length > 0 )
                        ok = false
                }
                if ( ok )
                    return true
                ev.preventDefault()  // interrompe o submit no caso de erro no form
                ev.stopPropagation()
                return false
            })
        </script>
    </body>
</html>